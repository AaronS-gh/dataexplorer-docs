---
title: log_reduce_predict_full_fl() - Azure Data Explorer
description: This article describes the log_reduce_predict_full_fl() user-defined function in Azure Data Explorer.
ms.reviewer: adieldar
ms.topic: reference
ms.date: 24/10/2022
---
# log_reduce_predict_full_fl()

The function `log_reduce_predict_full_fl()` matches lines of a semi-structured textual column to patterns. The parameters of the pattern are extracted to a separate column. The patterns are retrieved from a pre-trained model, generated by `log_reduce_train_fl()`.

> [!NOTE]
> * `log_reduce_predict_full_fl()` is a [UDF (user-defined function)](../query/functions/user-defined-functions.md). For more information, see [usage](#usage).
> * This function contains inline Python and requires [enabling the python() plugin](../query/pythonplugin.md#enable-the-plugin) on the cluster.

## Syntax
`T | invoke log_reduce_predict_full_fl(`*models_tbl*`,` *model_name*`,` *reduce_col*`,` *pattern_col*`,` *parameters_col*`,` *anomaly_str*`)`

## Arguments

* *models_tbl*: A table containing one or more outputs of `log_reduce_train_fl()`.
  * Expected format: name:string, timestamp: datetime, model:string.
  * It is expected that the *models_tbl* will contain a row whose *name* value is *model_name*, and that the model contained in this row will be on similar data to the input table. For example, the model can be a sub-sample of the full log, or a model trained on a similar table between different dates.
* *model_name*: The name of the model that will be retrieved from *models_tbl*. If several matching rows exist, the one with the most recent timestamp will be used.
* *reduce_col*: The name of the column the algorithm is applied to.
* *pattern_col*: The output column for the patterns.
* *parameters_col*: The output column for the parameters. 
  * Format: The parameters will be saved in a json encoded dictionary, where the keys are *parameter_0*,...,*parameter_N*, and the the value of *parameter_K* is the *K+1* parameter (K+1, instead of K, since the counting is 0-based).
* *anomaly_str*: This string will be used to represent lines that match no pattern in the model.
  * Default value: "ANOMALY".

## Usage

`log_reduce_predict_full_fl()` is a user-defined [tabular function](../query/functions/user-defined-functions.md#tabular-function) to be applied using the [invoke operator](../query/invokeoperator.md). You can either embed its code in your query, or install it in your database. There are two usage options: ad hoc and persistent usage. See the below tabs for examples.

# [Ad hoc](#tab/adhoc)

For ad hoc usage, embed the code using the [let statement](../query/letstatement.md). No permission is required.

<!-- csl: https://help.kusto.windows.net/Samples -->
In the example below, assume that the table *ML_models* was previously generated using `BGL_logs | invoke log_reduce_train_fl(reduce_col="data", model_name="BGL")`.

~~~kusto
let log_reduce_predict_full_fl=(tbl:(*), models_tbl: (name:string, timestamp: datetime, model:string), model_name:string, reduce_col:string, pattern_col:string, parameters_col:string, anomaly_str: string = "ANOMALY")
{
    let model_str = toscalar(models_tbl | where name == model_name | top 1 by timestamp desc | project model);
    let kwargs = bag_pack('logs_col', reduce_col, 'output_patterns_col', pattern_col,'output_parameters_col', parameters_col, 'model', model_str, "anomaly_str", anomaly_str, 'output_type', "Full");
    let code = ```
if 1:
    from sandbox_utils import Zipackage
    Zipackage.install('LogReduceFilter.zip')
    from LogReduceFilter import LogReducePredict
    result = LogReducePredict.log_reduce_predict(df, kargs)
```;
    tbl
    | evaluate hint.distribution=per_node python(typeof(*), code, kwargs, external_artifacts =
    bag_pack('LogReduceFilter.zip', 'https://adiwesteurope.blob.core.windows.net/python-we/LogReduceFilter/LogReduceFilter-0.2.39-py3-none-any.zip')
)
};
// Finds common patterns in BGL_logs, a commonly used benchmark for log parsing (as the name suggests, the benchmark contains logs of the BGL system).
BGL_logs
| take 100000 
| extend Patterns="", Parameters=""
| invoke log_reduce_predict_full_fl(models_tbl=ML_models, model_name="BGL", reduce_col="data", pattern_col="Patterns", parameters_col="Parameters")
~~~

# [Persistent](#tab/persistent)

For persistent usage, use [`.create function`](../management/create-function.md). Creating a function requires [database user permission](../management/access-control/role-based-authorization.md).

### One-time installation

~~~kusto
.create-or-alter function with (folder = "Packages\\Text", docstring = "Apply an existing log clustering to a new log corpus")
log_reduce_predict_full_fl(tbl:(*), models_tbl: (name:string, timestamp: datetime, model:string), model_name:string, reduce_col:string, pattern_col:string, parameters_col:string, anomaly_str: string = "ANOMALY")
{
    let model_str = toscalar(models_tbl | where name == model_name | top 1 by timestamp desc | project model);
    let kwargs = bag_pack('logs_col', reduce_col, 'output_patterns_col', pattern_col,'output_parameters_col', parameters_col, 'model', model_str, "anomaly_str", anomaly_str, 'output_type', "Full");
    let code = ```
if 1:
    from sandbox_utils import Zipackage
    Zipackage.install('LogReduceFilter.zip')
    from LogReduceFilter import LogReducePredict
    result = LogReducePredict.log_reduce_predict(df, kargs)
```;
    tbl
    | evaluate hint.distribution=per_node python(typeof(*), code, kwargs, external_artifacts =
    bag_pack('LogReduceFilter.zip', 'https://adiwesteurope.blob.core.windows.net/python-we/LogReduceFilter/LogReduceFilter-0.2.39-py3-none-any.zip')
)
}
~~~

### Usage

<!-- csl: https://help.kusto.windows.net/Samples -->
```kusto
// Finds common patterns in 1M entries from the HDFS_log, a commonly used benchmark for log parsing. The table ML_models is assumed to contain a model trained on 100K entries, generated by `HDFS_log | take 100000 | invoke log_reduce_train_fl(reduce_col="data", model_name="HDFS_100k_patterns")`. 
HDFS_log
| take 1000000
| invoke log_reduce_predict_fl(models_tbl=ML_models, model_name="HDFS_100k_patterns", reduce_col="data")
```

---

Result:
<!-- csl: https://help.kusto.windows.net/Samples -->
```kusto
Count	LogReduce	example
119854	081110 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* NameSystem.addStoredBlock: blockMap updated: <IP> is added to blk_<NUM> size <NUM>	081110 215858 27 INFO dfs.FSNamesystem: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.250.11.85:50010 is added to blk_5080254298708411681 size 67108864
118195	081110 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: Receiving block blk_<NUM> src: <IP> dest: <IP>	081110 215858 15494 INFO dfs.DataNode$DataXceiver: Receiving block blk_-7037346755429293022 src: /10.251.43.21:45933 dest: /10.251.43.21:50010
117954	081110 <NUM> <NUM> INFO dfs.DataNode$PacketResponder: PacketResponder <NUM> for block blk_<NUM> terminating	081110 215858 15496 INFO dfs.DataNode$PacketResponder: PacketResponder 2 for block blk_-7746692545918257727 terminating
117950	081110 <NUM> <NUM> INFO dfs.DataNode$PacketResponder: Received block blk_<NUM> of size <NUM> from <IP>	081110 215858 15485 INFO dfs.DataNode$PacketResponder: Received block blk_5080254298708411681 of size 67108864 from /10.251.43.21
114252	081110 <NUM> <NUM> INFO <*>: <*> block blk_<NUM> <*> <*>	081110 215957 15556 INFO dfs.DataNode$DataTransfer: 10.250.15.198:50010:Transmitted block blk_-3782569120714539446 to /10.251.203.129:50010
112363	081110 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* <*>: <*> <*> <*> <*> <*> <*> <*>	081110 220623 26 INFO dfs.FSNamesystem: BLOCK* NameSystem.delete: blk_1239016582509138045 is added to invalidSet of 10.251.123.195:50010
103042	081111 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* <*>: <*> <*> <*> <*> <*> <*> <*>	081111 023009 27 INFO dfs.FSNamesystem: BLOCK* NameSystem.delete: blk_1002466189951969180 is added to invalidSet of 10.251.30.179:50010
66831	081111 <NUM> <NUM> INFO <*>: <*> block blk_<NUM> <*> <*>	081111 023039 18 INFO dfs.FSDataset: Deleting block blk_-9208003345234441611 file /mnt/hadoop/dfs/data/current/subdir37/blk_-9208003345234441611
39157	081110 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* NameSystem.allocateBlock: <*>. <*>	081110 215858 26 INFO dfs.FSNamesystem: BLOCK* NameSystem.allocateBlock: /user/root/rand3/_temporary/_task_200811101024_0005_m_001805_0/part-01805. blk_-7037346755429293022
38899	081111 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: <*> <*> block blk_<NUM> <*> <*>	081111 000000 16694 INFO dfs.DataNode$DataXceiver: 10.251.203.129:50010 Served block blk_4985553474858702725 to /10.251.90.64
27043	ANOMALY	081110 215924 27 WARN dfs.FSNamesystem: BLOCK* NameSystem.addStoredBlock: Redundant addStoredBlock request received for blk_2522553781740514003 on 10.251.202.134:50010 size 67108864
12848	081110 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: <*> <*> block blk_<NUM> <*> <*>	081110 220706 15776 INFO dfs.DataNode$DataXceiver: 10.251.193.224:50010 Served block blk_5351989758085444015 to /10.250.19.102
3314	081111 <NUM> <NUM> INFO dfs.DataBlockScanner: Verification succeeded for <*>	081111 000004 13 INFO dfs.DataBlockScanner: Verification succeeded for blk_-6199176565791102563
2304	081110 <NUM> <NUM> INFO dfs.DataBlockScanner: Verification succeeded for <*>	081110 215859 13 INFO dfs.DataBlockScanner: Verification succeeded for blk_-7244926816084627474
1036	081110 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: Received block blk_<NUM> src: <IP> dest: <IP> of size <NUM>	081110 215957 15226 INFO dfs.DataNode$DataXceiver: Received block blk_-3782569120714539446 src: /10.250.15.198:51013 dest: /10.250.15.198:50010 of size 14474705
1012	081110 <NUM> <NUM> INFO <*>: <*> <*> <*> <*> <*> block blk_<NUM> <*> <*>	081110 215955 18 INFO dfs.DataNode: 10.250.15.198:50010 Starting thread to transfer block blk_-3782569120714539446 to 10.251.203.129:50010
1012	081110 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* <*> <*> <*> <*> <*> <*> <*> <*>	081110 215953 19 INFO dfs.FSNamesystem: BLOCK* ask 10.250.15.198:50010 to replicate blk_-3782569120714539446 to datanode(s) 10.251.203.129:50010
777	081111 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: Receiving block blk_<NUM> src: <IP> dest: <IP>	081111 023043 17856 INFO dfs.DataNode$DataXceiver: Receiving block blk_-4145674605155741075 src: /10.250.19.102:58044 dest: /10.250.19.102:50010
753	081111 <NUM> <NUM> INFO dfs.DataNode$PacketResponder: Received block blk_<NUM> of size <NUM> from <IP>	081111 023044 17739 INFO dfs.DataNode$PacketResponder: Received block blk_-4145674605155741075 of size 91178 from /10.251.123.195
753	081111 <NUM> <NUM> INFO dfs.DataNode$PacketResponder: PacketResponder <NUM> for block blk_<NUM> terminating	081111 023044 17739 INFO dfs.DataNode$PacketResponder: PacketResponder 0 for block blk_-4145674605155741075 terminating
254	081111 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* NameSystem.allocateBlock: <*>. <*>	081111 023043 35 INFO dfs.FSNamesystem: BLOCK* NameSystem.allocateBlock: /mnt/hadoop/mapred/system/job_200811101024_0009/job.jar. blk_-4145674605155741075
154	081111 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* NameSystem.addStoredBlock: blockMap updated: <IP> is added to blk_<NUM> size <NUM>	081111 023044 31 INFO dfs.FSNamesystem: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.251.31.180:50010 is added to blk_-4145674605155741075 size 91178
125	081110 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: <*> <*> <*> <*> <*>: <*> <*> <*> <*> <*>	081110 215936 15714 INFO dfs.DataNode$DataXceiver: writeBlock blk_720939897861061328 received exception java.io.IOException: Could not read from stream
51	081110 <NUM> <NUM> INFO <*>: <*> <*> <*> for block <*>	081110 215924 15636 INFO dfs.DataNode$BlockReceiver: Receiving empty packet for block blk_3991288654265301939
16	081110 <NUM> <NUM> INFO <*>: <*> <*> <*> <*> <*> block blk_<NUM> <*> <*>, <*>	081110 220701 19 INFO dfs.DataNode: 10.251.194.102:50010 Starting thread to transfer block blk_2840381344531092349 to 10.251.90.134:50010, 10.251.43.115:50010
16	081110 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* <*> <*> <*> <*> <*> <*> <*> <*> <*>	081110 220701 19 INFO dfs.FSNamesystem: BLOCK* ask 10.251.194.102:50010 to replicate blk_2840381344531092349 to datanode(s) 10.251.90.134:50010 10.251.43.115:50010
11	081111 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: Received block blk_<NUM> src: <IP> dest: <IP> of size <NUM>	081111 023050 17765 INFO dfs.DataNode$DataXceiver: Received block blk_-4145674605155741075 src: /10.251.123.195:53597 dest: /10.251.123.195:50010 of size 91178
5	081111 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* <*> <*> <*> <*> <*> <*> <*> <*> <*>	081111 023045 19 INFO dfs.FSNamesystem: BLOCK* ask 10.251.123.195:50010 to replicate blk_-4145674605155741075 to datanode(s) 10.251.195.70:50010 10.251.67.211:50010
5	081111 <NUM> <NUM> INFO <*>: <*> <*> <*> <*> <*> block blk_<NUM> <*> <*>, <*>	081111 023048 18 INFO dfs.DataNode: 10.251.123.195:50010 Starting thread to transfer block blk_-4145674605155741075 to 10.251.195.70:50010, 10.251.67.211:50010
3	081111 <NUM> <NUM> INFO <*>: <*> <*> <*> <*> <*> block blk_<NUM> <*> <*>	081111 023051 19 INFO dfs.DataNode: 10.251.195.33:50010 Starting thread to transfer block blk_-3588411987248750371 to 10.250.19.16:50010
3	081111 <NUM> <NUM> INFO dfs.FSNamesystem: BLOCK* <*> <*> <*> <*> <*> <*> <*> <*>	081111 023048 19 INFO dfs.FSNamesystem: BLOCK* ask 10.251.195.33:50010 to replicate blk_-3588411987248750371 to datanode(s) 10.250.19.16:50010
2	081110 <NUM> <NUM> INFO dfs.DataNode$PacketResponder: PacketResponder <*> <*> <*> <*>	081110 230655 16832 INFO dfs.DataNode$PacketResponder: PacketResponder blk_-539148231797001003 2 Exception java.io.EOFException
2	081110 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: <*> <*> <*> <*> <*>: <*> <*> <*> <*>	081110 230703 16811 INFO dfs.DataNode$DataXceiver: writeBlock blk_-539148231797001003 received exception java.io.IOException: Connection reset by peer
2	081110 <NUM> <NUM> INFO dfs.DataNode$DataXceiver: <*> <*> <*> <*> <*>	081110 230705 12686 INFO dfs.DataNode$DataXceiver: writeBlock blk_-539148231797001003 received exception java.io.EOFException
2	081110 <NUM> <NUM> INFO <*>: <*> <*> <*> for block blk_<NUM> <*>: <*> <*> <*> <*>	081110 230703 16811 INFO dfs.DataNode$BlockReceiver: Exception in receiveBlock for block blk_-539148231797001003 java.io.IOException: Connection reset by peer
```
